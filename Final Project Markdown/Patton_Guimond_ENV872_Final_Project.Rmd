---
title: "Patton & Guimond Final Project: EVAULATING TEMPERATURE TRENDS AT US ARMY BASIC TRAINING INSTALLATIONS"
author: "Erik Patton & Austin Guimond"
date: "Fall 2022"
output:
  html_document: default
  pdf_document: default
editor_options: 
  markdown: 
    wrap: 72
---

```{=tex}
\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage
```
```{r setup, include=FALSE}
# Set your working directory

# Load your packages
#install.packages('TinyText')
#install.packages('LaTex')
#library(LaTex)
#install.packages('agricolae')
#install.packages('corrplot')
#install.packages('sf')
#install.packages('mapview')
#install.packages("viridis")
library(tidyverse)
library(lubridate)
library(zoo)
library(ggplot2)
library(trend)
library(Kendall)
library(tseries)
library(dplyr)
library(formatR)
library(agricolae)
library(corrplot)
library(mapview)
library(sf)
library(leaflet)
library(viridis)
library(cowplot)

# Set your ggplot theme


# Load temperature data sets
#Jackson_Raw <- read.csv("~/R/Patton_Guimond_ENV872_Final_Project/Data/Raw Data/Jackson_TenYear.csv",
#                         stringsAsFactors = TRUE)
#KFSI_Clean <- read.csv("~/R/Patton_Guimond_ENV872_Final_Project/Data/Processed Data/KFSI_Clean.csv",
#                         stringsAsFactors = TRUE)
#KLSF_Clean <- read.csv("~/R/Patton_Guimond_ENV872_Final_Project/Data/Processed Data/KLSF_Clean.csv",
#                         stringsAsFactors = TRUE) 
#KTBN_Clean <- read.csv("~/R/Patton_Guimond_ENV872_Final_Project/Data/Processed Data/KTBN_Clean.csv",
#                         stringsAsFactors = TRUE) 



#Load data sets for mapping visualization
All_Installations_sf <- st_read('/Users/erikpatton/Library/Mobile Documents/com~apple~CloudDocs/Duke/Data_Dissertation/Map Data/tl_2019_us_mil/tl_2019_us_mil.shp')%>%
  select('FULLNAME','geometry')%>%
  filter(FULLNAME=="Ft Jackson"|FULLNAME=="Ft Benning"|FULLNAME=="Ft Sill"|FULLNAME=="Ft Leonard Wood")
All_Counties <- st_read('/Users/erikpatton/Library/Mobile Documents/com~apple~CloudDocs/R Files/Patton_Guimond_ENV872_Final_Project/Data/Raw Data/cb_2018_us_county_20m')

```

```{r Eriks read in code chunk}

Jackson_Raw <- read.csv("~/Library/Mobile Documents/com~apple~CloudDocs/R Files/Patton_Guimond_ENV872_Final_Project/Data/Raw Data/Jackson_TenYear.csv",
                         stringsAsFactors = TRUE)
KFSI_Clean <- read.csv("~/Library/Mobile Documents/com~apple~CloudDocs/R Files/Patton_Guimond_ENV872_Final_Project/Data/Processed Data/KFSI_Clean.csv",
                         stringsAsFactors = TRUE)
KLSF_Clean <- read.csv("~/Library/Mobile Documents/com~apple~CloudDocs/R Files/Patton_Guimond_ENV872_Final_Project/Data/Processed Data/KLSF_Clean.csv",
                         stringsAsFactors = TRUE) 
KTBN_Clean <- read.csv("~/Library/Mobile Documents/com~apple~CloudDocs/R Files/Patton_Guimond_ENV872_Final_Project/Data/Processed Data/KTBN_Clean.csv",
                         stringsAsFactors = TRUE) 
```

Full code can be found [here](https://github.com/auguimond/Patton_Guimond_ENV872_Final_Project) at the project GitHub repository.

# Rationale and Research Questions

## Rationale

This project advances research done as a part of a dissertation by analyzing temperature trends against the thresholds set to protect against heat illness during physical activity. Although it analyzes temperatures on military basic training installations and references temperature thresholds derived by the military, there is broad applicability to any population that performs physically demanding outdoor work.

## Research Questions

### Research Question #1: Has there been a change to temperature trends at the four army basic training installations in the decade between 2012-2022?

#### \* 1a: Are trends the same or different for Heat Index and Wet Bulb Globe Temperature?

#### \* 1b: Are there statistically significant trends in the number of "Black Flag" and "Red Flag" days at the installations?

### Research Question #2: How many days was the temperature in each of the "Color Flag" temperature categories for each installation?

\newpage

# Dataset Information

Four datasets were obtained from the US Air Force 14th Weather Squadron, which collects "authoritative climate data" for the military. Each dataset contains observations from a weather gauge on or near one of four army basic training installations (Table 1).

|| Fort Jackson, SC |Fort Benning, GA |Fort Sill, OK |Fort Leonard Wood, MO| 
|:--- | :---: | :---: | :---: | :---: | 
|Installation Abbreviation |FJSC|FBGA|FSOK|FLW| 
|Weather Station ID|KCUB|KLSF|KFSI|KTBN| 
|OBSERVATIONS|93,099|93,016|91,404|92,202|

Hourly data for the period of 2012-01-01 00:00:00 to 2022-09-30 23:00 was provided for each basic training installation. Data included the following observations: Temperature (F), Dewpoint (F), Relative Humidity, Heat Index (F), Derived Wet Bulb Globe Temperature (F). Each of the files contained over 91,000 observations, with the individual file's number of observations dependent on the number of missing observations.

```{r HOURLY DATA HEADER}
#example of the first ten weather observations made at Ft Jackson, SC.
head(Jackson_Raw, n=5)
```

Publicly releasable version of shapefile data for military installations was obtained from the Defense Installations Spatial Data Infrastructure portal. This file includes data on nine attributes (variables) for 859 military installations (observations) within United States territory. The data file was wrangled using the dyplr pipe function to first select for two columns, 'FULLNAME' and 'geometry', then filtering by 'FULLNAME' for each of the four installations of interest. This resulted in five 1x2 size data frames, one for each of the four installations, containing location name and multipolygon geometry. Note that Ft Leonard Wood appears as two separate files due to a non-contiguous piece of training land.

```{r}
(All_Installations_sf)
```

2018 county data at 20-meter resolution was obtained from the US Census Bureau and used to build State boundary maps. This file contains data for ten attributes (variables) for 3,220 counties (observations) within the United States. A data frame for each State with a basic training installation was created by filtering this dataset using the appropriate STATEFP, resulting in a data frame for each State of 10 variables and the number of observations corresponding to the number of counties in the State.

```{r, include=FALSE }
GA_counties_sf<- All_Counties %>% 
  filter(STATEFP == 13) 

MO_counties_sf<- All_Counties %>% 
  filter(STATEFP == 29) 

SC_counties_sf<- All_Counties %>% 
  filter(STATEFP == 45) 

OK_counties_sf<- All_Counties %>% 
  filter(STATEFP == 40) 

head(SC_counties_sf)
mapview(SC_counties_sf)
```

\newpage

# Exploratory Analysis

## Exploratory Analysis Question #1a: Are trends the same or different for Heat Index and Wet Bulb Globe Temperature?

The data was organized with the intended purpose of narrowing the datasets to date, temperature, and wet bulb temperatures. The original unedited data contained unnecessary columns and rows between each entry. The first step was to filter for day month, year, and temperature. A new date column was added in 'date' format using the lubridate package. The temperature data is recorded in the data files in hourly increments that would be difficult to analyze for temperature trends. For simplicity, the max daily temperature values were wrangled by grouping the data by date and using the value=max command. To isolate trends in summer temperatures, the same procedure was repeated, but two new data frames were created to filter for the months of April to September. For each military base, the daily maximum temperature and wet bulb temperature values were plotted over time and a trend line was added. The plot for all four locations showed upward linear trends from 2012 -- 2022.

```{r wrangle data, include=FALSE}

###Wrangle all data for Temperature
#Start with Fort Jackson
Jackson_Wrangle <- Jackson_Raw %>%
  select(YEAR, MO, DAY, TEMPC) %>%
  mutate('date' = make_date(year = YEAR, month = MO, day = DAY))

#Set as date
Jackson_Wrangle$date <- as.Date(Jackson_Wrangle$date, format = "%y/%m/%d")

#Group by date and find max daily temperature
Daily_High <- Jackson_Wrangle %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (TEMPC)) %>% 
  as.data.frame()
#Plot max temperatures over time
MaxTemp_Plot <- ggplot(Daily_High, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Max Temperatures Over Time")+
  xlab("Time (Days)") + ylab("Temperature (C)")
print(MaxTemp_Plot)

#Look for NA values in data and remove
summary(Daily_High$value)
Clean_MaxTemp <- 
  Daily_High %>% 
  mutate(Temp_Clean = zoo::na.approx(value))
summary(Clean_MaxTemp)

#Filter for date and NA omitted Temp
Max_Temp <- Clean_MaxTemp%>%
  select(date, Temp_Clean)
summary(Max_Temp)

###Wranlge Fort Sill Data
KFSI_Wrangle <- KFSI_Clean %>%
  select(Year, Month, Day, Temperature..F.) %>%
  mutate('date' = make_date(year = Year, month = Month, day = Day)) %>%
           mutate('Temp_C' = ((Temperature..F.-32)/1.8 ))

#Set as date
KFSI_Wrangle$date <- as.Date(KFSI_Wrangle$date, format = "%y/%m/%d")
KFSI_Wrangle_Update <- KFSI_Wrangle %>%
  select(date, Temp_C)

#Group by date and find max daily temperature
Daily_High_KFSI <- KFSI_Wrangle_Update %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (Temp_C)) %>% 
  as.data.frame()
#Plot max temperatures over time
KFSI_MaxTemp_Plot <- ggplot(Daily_High_KFSI, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Max Temperatures Over Time")+
  xlab("Time (Days)") + ylab("Temperature (C)")
print(KFSI_MaxTemp_Plot)

#Look for NA values in data and remove
summary(Daily_High_KFSI$value)
KFSI_Filtered_Date <- Daily_High_KFSI %>%
  filter(between(date, as.Date("2012-01-10"), as.Date("2022-09-30")))
#Estimate NA values and filter for date and temperature
Clean_MaxTemp_KSFI <- 
  KFSI_Filtered_Date %>% 
  mutate(Temp_Clean = zoo::na.approx(value))
summary(Clean_MaxTemp_KSFI)
Clean_MaxTemp_KSFI <- Clean_MaxTemp_KSFI %>%
  select(date,Temp_Clean)
summary(Clean_MaxTemp_KSFI)



###Wrangle Fort Benning Data
KLSF_Wrangle <- KLSF_Clean %>%
  select(Year, Month, Day, Temperature..F.) %>%
  mutate('date' = make_date(year = Year, month = Month, day = Day)) %>%
           mutate('Temp_C' = ((Temperature..F.-32)/1.8 ))

#Set as date
KLSF_Wrangle$date <- as.Date(KLSF_Wrangle$date, format = "%y/%m/%d")
KLSF_Wrangle_Update <- KLSF_Wrangle %>%
  select(date, Temp_C)

#Group by date and find max daily temperature
Daily_High_KLSF <- KLSF_Wrangle_Update %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (Temp_C)) %>% 
  as.data.frame()
#Plot max temperatures over time
KLSF_MaxTemp_Plot <- ggplot(Daily_High_KLSF, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Max Temperatures Over Time")+
  xlab("Time (Days)") + ylab("Temperature (C)")
print(KLSF_MaxTemp_Plot)

#Look for NA values in data and remove
summary(Daily_High_KLSF$value)
KLSF_Filtered_Date <- Daily_High_KLSF %>%
  filter(between(date, as.Date("2012-01-10"), as.Date("2022-09-30")))
#Estimate NA Dates
Clean_MaxTemp_KLSF <- 
  KLSF_Filtered_Date %>% 
  mutate(Temp_Clean = zoo::na.approx(value))
summary(Clean_MaxTemp_KLSF)
#Select Temperature and date columns 
Clean_MaxTemp_KLSF <- Clean_MaxTemp_KLSF %>%
  select(date,Temp_Clean)
summary(Clean_MaxTemp_KLSF)



###Wranlge Fort Leonard Data
KTBN_Wrangle <- KTBN_Clean %>%
  select(Year, Month, Day, Temperature..F.) %>%
  mutate('date' = make_date(year = Year, month = Month, day = Day)) %>%
           mutate('Temp_C' = ((Temperature..F.-32)/1.8 ))

#Set as date
KTBN_Wrangle$date <- as.Date(KTBN_Wrangle$date, format = "%y/%m/%d")
KTBN_Wrangle_Update <- KTBN_Wrangle %>%
  select(date, Temp_C)

#Group by date and find max daily temperature
Daily_High_KTBN <- KTBN_Wrangle_Update %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (Temp_C)) %>% 
  as.data.frame()
#Plot max temperatures over time
KTBN_MaxTemp_Plot <- ggplot(Daily_High_KTBN, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Max Temperatures Over Time")+
  xlab("Time (Days)") + ylab("Temperature (C)")
print(KTBN_MaxTemp_Plot)

#Look for NA values in data and remove
summary(Daily_High_KTBN$value)
KTBN_Filtered_Date <- Daily_High_KTBN %>%
  filter(between(date, as.Date("2012-01-10"), as.Date("2022-09-30")))

Clean_MaxTemp_KTBN <- 
  KTBN_Filtered_Date %>% 
  mutate(Temp_Clean = zoo::na.approx(value))
summary(Clean_MaxTemp_KTBN)

Clean_MaxTemp_KTBN <- Clean_MaxTemp_KTBN %>%
    select(date,Temp_Clean)
summary(Clean_MaxTemp_KTBN)



###Wrangle all wet bulb data
#Wet bulb temperature Jacksonville
#Group by date and find max daily temperature
Jackson_Wrangle_WBT <- Jackson_Raw %>%
  select(YEAR, MO, DAY, WBGTC) %>%
  mutate('date' = make_date(year = YEAR, month = MO, day = DAY))

#Set as date
Jackson_Wrangle_WBT$date <- as.Date(Jackson_Wrangle_WBT$date, format = "%y/%m/%d")

#Group by date and find max daily temperature
Daily_High_WBT <- Jackson_Wrangle_WBT %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (WBGTC)) %>% 
  as.data.frame()
#Plot max temperatures over time
MaxWBTG_Plot <- ggplot(Daily_High_WBT, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Max Wet Bulb Over Time")+
  xlab("Time (Days)") + ylab("Wet Bulb Globe Temperature")
print(MaxWBTG_Plot)

#Look for NA values in data and remove
summary(Daily_High_WBT$value)
Clean_WetBulb <- 
  Daily_High %>% 
  mutate(WBGTC_Clean = zoo::na.approx(value))
summary(Clean_WetBulb)

#Filter for date and NA omitted Temp
Max_WetBulb <- Clean_WetBulb%>%
  select(date, WBGTC_Clean)
summary(Max_WetBulb)


###Wrangle Fort Sill WBT
KFSI_Wrangle_WBT <- KFSI_Clean %>%
  select(Year, Month, Day, Derived.Wet.Bulb.Globe.Temperature..F.) %>%
  mutate('date' = make_date(year = Year, month = Month, day = Day))

#Set as date
KFSI_Wrangle_WBT$date <- as.Date(KFSI_Wrangle_WBT$date, format = "%y/%m/%d")
KFSI_Wrangle_Update_WBT <- KFSI_Wrangle_WBT %>%
  select(date, Derived.Wet.Bulb.Globe.Temperature..F.)

#Group by date and find max daily temperature
Daily_High_KFSI_WBT <- KFSI_Wrangle_Update_WBT %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (Derived.Wet.Bulb.Globe.Temperature..F.)) %>% 
  as.data.frame()
#Plot max wet bulb temperatures over time
KFSI_Max_WetBulb_Plot <- ggplot(Daily_High_KFSI, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Max Wet Bulb Temperatures Over Time")+
  xlab("Time (Days)") + ylab("Wet Bulb (F)")
print(KFSI_Max_WetBulb_Plot)

#Look for NA values in data and remove. Create date range for avalaible data
summary(Daily_High_KFSI_WBT$value)
KFSI_Filtered_Date_WBT <- Daily_High_KFSI_WBT %>%
  filter(between(date, as.Date("2012-01-10"), as.Date("2022-09-30")))
#estimate NA values by average
Clean_Max_WetBulb_KSFI <- 
  KFSI_Filtered_Date_WBT %>% 
  mutate(Wet_Bulb = zoo::na.approx(value))
summary(Clean_Max_WetBulb_KSFI)
Clean_Max_WetBulb_KSFI <- Clean_Max_WetBulb_KSFI %>%
  select(date,Wet_Bulb)
summary(Clean_Max_WetBulb_KSFI)



###Wrangle Fort Benning
KLSF_Wrangle_WBT <- KLSF_Clean %>%
  select(Year, Month, Day, Derived.Wet.Bulb.Globe.Temperature..F.) %>%
  mutate('date' = make_date(year = Year, month = Month, day = Day)) 
         
#Set as date
KLSF_Wrangle_WBT$date <- as.Date(KLSF_Wrangle_WBT$date, format = "%y/%m/%d")
KLSF_Wrangle_Update_WBT <- KLSF_Wrangle_WBT %>%
  select(date, Derived.Wet.Bulb.Globe.Temperature..F.)

#Group by date to remove blank rows and find max daily temperature
Daily_High_KLSF_WBT <- KLSF_Wrangle_Update_WBT %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (Derived.Wet.Bulb.Globe.Temperature..F.)) %>% 
  as.data.frame()
#Plot max wet bulb temperatures over time
KLSF_Max_Wet_Bulb_Plot <- ggplot(Daily_High_KLSF_WBT, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Max Wet Bulb Temperatures Over Time")+
  xlab("Time (Days)") + ylab("Wet Bulb (F)")
print(KLSF_Max_Wet_Bulb_Plot)

#Look for NA values in data and set date range
summary(Daily_High_KLSF_WBT$value)
KLSF_Filtered_Date_WBT <- Daily_High_KLSF_WBT %>%
  filter(between(date, as.Date("2012-01-10"), as.Date("2022-09-30")))
#remove NA values by approximating value
Clean_Max_WetBulb_KLSF <- 
  KLSF_Filtered_Date_WBT %>% 
  mutate(Wet_Bulb = zoo::na.approx(value))
summary(Clean_Max_WetBulb_KLSF)
#Select wet bulb and date columns
Clean_Max_WetBulb_KLSF <- Clean_Max_WetBulb_KLSF %>%
  select(date,Wet_Bulb)
summary(Clean_Max_WetBulb_KLSF)



###Wrangle wet bulb temperature Fort Leonard Wood
KTBN_Wrangle_WBT <- KTBN_Clean %>%
  select(Year, Month, Day, Derived.Wet.Bulb.Globe.Temperature..F.) %>%
  mutate('date' = make_date(year = Year, month = Month, day = Day))

#Set as date
KTBN_Wrangle_WBT$date <- as.Date(KTBN_Wrangle_WBT$date, format = "%y/%m/%d")
KTBN_Wrangle_Update_WBT <- KTBN_Wrangle_WBT %>%
  select(date, Derived.Wet.Bulb.Globe.Temperature..F.)

#Group by date and find max daily wet bulb temperature
Daily_High_KTBN_WBT <- KTBN_Wrangle_Update_WBT %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (Derived.Wet.Bulb.Globe.Temperature..F.)) %>% 
  as.data.frame()
#Plot max wet bulb temperatures over time
KTBN_Max_WetBulb_Plot <- ggplot(Daily_High_KTBN_WBT, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Wet Bulb Temperatures Over Time")+
  xlab("Time (Days)") + ylab("Wet Bulb (F)")
print(KTBN_Max_WetBulb_Plot)

#Look for NA values in data and remove
summary(Daily_High_KTBN_WBT$value)
KTBN_Filtered_Date_WBT <- Daily_High_KTBN_WBT %>%
  filter(between(date, as.Date("2012-01-10"), as.Date("2022-09-30")))
#estimate max values to remove NA
Clean_Max_WetBulb_KTBN <- 
  KTBN_Filtered_Date_WBT %>% 
  mutate(Wet_Bulb = zoo::na.approx(value))
summary(Clean_Max_WetBulb_KTBN)
#Select wet bulb and date data columns
Clean_Max_WetBulb_KTBN <- Clean_Max_WetBulb_KTBN %>%
    select(date,Wet_Bulb)
summary(Clean_Max_WetBulb_KTBN)

```

Trends in temperature and wet bulb temperature were explored using time series analysis. The new data frame was first set to a period time series object with a frequency of 365 days. The time series object for temperature and wet bulb temperature was analyzed using a seasonal Mann Kendall test which accounts for the inherent seasonality in the temperature data. To remove the seasonality variable from the data, each time series object was decomposed, and a new data frame was created with the date, temperature variable, and seasonality. Using mutate, a new seasonally adjusted column was added with seasonality values subtracted from the temperature or wet bulb temperature. Once seasonality was removed, a Mann Kendall test was performed and the p --values were compared to the results of the seasonal Mann Kendall test. This same procedure was replicated for data filtered for the months of April to September.

##### Ft Jackson High Temperature Trend

```{r Jackson Full Season Time Series Analysis}
###Jackson Temperature Time Series 
Daily_High_ts <- ts(Max_Temp$Temp_Clean, start = c(2012,01,01), frequency = 365)
Daily_High_decomp <- stl(Daily_High_ts,s.window = "periodic")
plot(Daily_High_decomp)

Daily_Temp_Trend <- Kendall::SeasonalMannKendall(Daily_High_ts)
summary(Daily_Temp_Trend)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components <- as.data.frame(Daily_High_decomp$time.series[,1:3])

Daily_Components <- mutate(Daily_Components,
        Temp_C = Max_Temp$Temp_Clean,     
        Date = Max_Temp$date)

TempSeasonAdj <- Daily_Components %>%
  mutate(Subtract.Season = Daily_Components$Temp_C - Daily_Components$seasonal)
summary(TempSeasonAdj)

NonSeasonal_Temp_Trend <- Kendall::MannKendall(TempSeasonAdj$Subtract.Season)
summary(NonSeasonal_Temp_Trend)
```

##### Ft Jackson WBGT Trend

```{r Jackson Full Season WBGT Time Series Analysis}
### Wet Bulb Temperature, Fort Jackson
#Jackson WBT Time Series
Daily_High_ts <- ts(Max_WetBulb$WBGTC_Clean, start = c(2012,01,01), frequency = 365)
Daily_High_decomp <- stl(Daily_High_ts,s.window = "periodic")
plot(Daily_High_decomp)

Daily_WetBulb_Trend <- Kendall::SeasonalMannKendall(Daily_High_ts)
summary(Daily_WetBulb_Trend)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components <- as.data.frame(Daily_High_decomp$time.series[,1:3])

Daily_Components <- mutate(Daily_Components,
        WBGTC = Max_WetBulb$WBGTC_Clean,     
        Date = Max_WetBulb$date)

WetBulb_SeasonAdj <- Daily_Components %>%
  mutate(Subtract.Season = Daily_Components$WBGTC - Daily_Components$seasonal)
summary(WetBulb_SeasonAdj)

NonSeasonal_WetBulb_Trend <- Kendall::MannKendall(WetBulb_SeasonAdj$Subtract.Season)
summary(NonSeasonal_WetBulb_Trend)

```

```{r Fort Sill, Benning, and Leonard Wood Temperature Time Series, include=FALSE}
###Fort Sill Temperature Time Series
Daily_High_KFSI_ts <- ts(Clean_MaxTemp_KSFI$Temp_Clean, start = c(2012,01,01), frequency = 365)
Daily_High_KFSI_decomp <- stl(Daily_High_KFSI_ts,s.window = "periodic")
plot(Daily_High_KFSI_ts)
#Run seasonal Mann Kendall Test
Daily_Temp_Trend_KFSI <- Kendall::SeasonalMannKendall(Daily_High_KFSI_ts)
summary(Daily_Temp_Trend_KFSI)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components_KFSI <- as.data.frame(Daily_High_KFSI_decomp$time.series[,1:3])
#Create data frame with date, max temp, and daily components
Daily_Components_KFSI <- mutate(Daily_Components_KFSI,
        Temp_C = Clean_MaxTemp_KSFI$Temp_Clean,     
        Date = Clean_MaxTemp_KSFI$date)
#Subtract seasonality 
TempSeasonAdj_KFSI <- Daily_Components_KFSI %>%
  mutate(Subtract.Season = Daily_Components_KFSI$Temp_C - Daily_Components_KFSI$seasonal)
summary(TempSeasonAdj_KFSI)
#Run Mann Kendall test
NonSeasonal_Temp_Trend_KFSI <- Kendall::MannKendall(TempSeasonAdj_KFSI$Subtract.Season)
summary(NonSeasonal_Temp_Trend_KFSI)



###Fort Benning Temperature Time Series
Daily_High_KLSF_ts <- ts(Clean_MaxTemp_KLSF$Temp_Clean, start = c(2012,01,01), frequency = 365)
Daily_High_KLSF_decomp <- stl(Daily_High_KLSF_ts,s.window = "periodic")
plot(Daily_High_KLSF_ts)
#Run seasonal Mann Kendall
Daily_Temp_Trend_KLSF <- Kendall::SeasonalMannKendall(Daily_High_KLSF_ts)
summary(Daily_Temp_Trend_KLSF)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components_KLSF <- as.data.frame(Daily_High_KLSF_decomp$time.series[,1:3])
#Create data frame with components
Daily_Components_KLSF <- mutate(Daily_Components_KLSF,
        Temp_C = Clean_MaxTemp_KLSF$Temp_Clean,     
        Date = Clean_MaxTemp_KLSF$date)
#Subtract Seasonality
TempSeasonAdj_KLSF <- Daily_Components_KLSF %>%
  mutate(Subtract.Season = Daily_Components_KLSF$Temp_C - Daily_Components_KLSF$seasonal)
summary(TempSeasonAdj_KLSF)
#Run Mann Kendall Test
NonSeasonal_Temp_Trend_KLSF <- Kendall::MannKendall(TempSeasonAdj_KLSF$Subtract.Season)
summary(NonSeasonal_Temp_Trend_KLSF)

### Fort Leonard Wood Temperature Time Series
Daily_High_KTBN_ts <- ts(Clean_MaxTemp_KTBN$Temp_Clean, start = c(2012,01,01), frequency = 365)
Daily_High_KTBN_decomp <- stl(Daily_High_KTBN_ts,s.window = "periodic")
plot(Daily_High_KTBN_ts)

Daily_Temp_Trend_KTBN <- Kendall::SeasonalMannKendall(Daily_High_KTBN_ts)
summary(Daily_Temp_Trend_KTBN)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components_KTBN <- as.data.frame(Daily_High_KTBN_decomp$time.series[,1:3])

Daily_Components_KTBN <- mutate(Daily_Components_KTBN,
        Temp_C = Clean_MaxTemp_KTBN$Temp_Clean,     
        Date = Clean_MaxTemp_KTBN$date)

TempSeasonAdj_KTBN <- Daily_Components_KTBN %>%
  mutate(Subtract.Season = Daily_Components_KTBN$Temp_C - Daily_Components_KTBN$seasonal)
summary(TempSeasonAdj_KTBN)

NonSeasonal_Temp_Trend_KTBN <- Kendall::MannKendall(TempSeasonAdj_KTBN$Subtract.Season)
summary(NonSeasonal_Temp_Trend_KTBN)

```

```{r Fort Sill, Benning, and Leonard Wood Wet Bulb Time Series, include=FALSE}
###Fort Sill WBT Time Series
Daily_High_KFSI_ts <- ts(Clean_Max_WetBulb_KSFI$Wet_Bulb, start = c(2012,01,01), frequency = 365)
Daily_High_KFSI_decomp <- stl(Daily_High_KFSI_ts,s.window = "periodic")
plot(Daily_High_KFSI_ts)
#Run seasonal Mann Kendall
Daily_Temp_Trend_KFSI <- Kendall::SeasonalMannKendall(Daily_High_KFSI_ts)
summary(Daily_Temp_Trend_KFSI)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components_KFSI <- as.data.frame(Daily_High_KFSI_decomp$time.series[,1:3])
#Create data frame with components, wet bulb temp, and date
Daily_Components_KFSI <- mutate(Daily_Components_KFSI,
        Wet_Bulb_F = Clean_Max_WetBulb_KSFI$Wet_Bulb,     
        Date = Clean_Max_WetBulb_KSFI$date)
#Subtract seasonality from wet bulb temperature data
TempSeasonAdj_KFSI <- Daily_Components_KFSI %>%
  mutate(Subtract.Season = Daily_Components_KFSI$Wet_Bulb_F - Daily_Components_KFSI$seasonal)
summary(TempSeasonAdj_KFSI)
#Run Mann Kendall Test
NonSeasonal_Temp_Trend_KFSI <- Kendall::MannKendall(TempSeasonAdj_KFSI$Subtract.Season)
summary(NonSeasonal_Temp_Trend_KFSI)
###Fort Benning 
Daily_High_KLSF_ts <- ts(Clean_Max_WetBulb_KLSF$Wet_Bulb, start = c(2012,01,01), frequency = 365)
Daily_High_KLSF_decomp <- stl(Daily_High_KLSF_ts,s.window = "periodic")
plot(Daily_High_KLSF_ts)
#Run seasonal Mann Kendall test
Daily_Temp_Trend_KLSF <- Kendall::SeasonalMannKendall(Daily_High_KLSF_ts)
summary(Daily_Temp_Trend_KLSF)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components_KLSF <- as.data.frame(Daily_High_KLSF_decomp$time.series[,1:3])
#Create data frame for components
Daily_Components_KLSF <- mutate(Daily_Components_KLSF,
        Wet_Bulb = Clean_Max_WetBulb_KLSF$Wet_Bulb,     
        Date = Clean_Max_WetBulb_KLSF$date)
#Subtract seasonality from wet bulb data
TempSeasonAdj_KLSF <- Daily_Components_KLSF %>%
  mutate(Subtract.Season = Daily_Components_KLSF$Wet_Bulb - Daily_Components_KLSF$seasonal)
summary(TempSeasonAdj_KLSF)
#Run Mann Kendall test
NonSeasonal_Temp_Trend_KLSF <- Kendall::MannKendall(TempSeasonAdj_KLSF$Subtract.Season)
summary(NonSeasonal_Temp_Trend_KLSF)


###Fort Leonard Wood WBT Time Series
Daily_High_KTBN_ts <- ts(Clean_Max_WetBulb_KTBN$Wet_Bulb, start = c(2012,01,01), frequency = 365)
Daily_High_KTBN_decomp <- stl(Daily_High_KTBN_ts,s.window = "periodic")
plot(Daily_High_KTBN_ts)
#Run seasonal Mann Kendall
Daily_WetBulb_Trend_KTBN <- Kendall::SeasonalMannKendall(Daily_High_KTBN_ts)
summary(Daily_WetBulb_Trend_KTBN)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components_KTBN <- as.data.frame(Daily_High_KTBN_decomp$time.series[,1:3])
#make data frame with seasonal component, date, and wet bulb
Daily_Components_KTBN <- mutate(Daily_Components_KTBN,
        Wet_Bulb = Clean_Max_WetBulb_KTBN$Wet_Bulb,     
        Date = Clean_Max_WetBulb_KTBN$date)
#Subtract seasonality
TempSeasonAdj_KTBN <- Daily_Components_KTBN %>%
  mutate(Subtract.Season = Daily_Components_KTBN$Wet_Bulb - Daily_Components_KTBN$seasonal)
summary(TempSeasonAdj_KTBN)
#Run Mann Kendall
NonSeasonal_Wet_Bulb_Trend_KTBN <- Kendall::MannKendall(TempSeasonAdj_KTBN$Subtract.Season)
summary(NonSeasonal_Wet_Bulb_Trend_KTBN)
```

##### Ft Jackson Summer Season High Temp Time Series Trend Analysis
```{r Fort Jackson Summer Time Series }
###Jackson Summer Time Series
#Filter for April to September 
Jackson_Summer <- Jackson_Wrangle %>%
  filter(MO== 4 | MO== 5 | MO== 6 | MO== 7 | MO== 8 | MO==9 )
Jackson_Summer$date <- as.Date(Jackson_Summer$date, format = "%y/%m/%d")

#Group by date and find max daily temperature
Daily_High_Summer <- Jackson_Summer %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (TEMPC)) %>% 
  as.data.frame()

#Plot max temperatures over time
MaxTemp_Plot_Summer <- ggplot(Daily_High_Summer, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Max Temperatures Over Time")+
  xlab("Time (Days)") + ylab("Temperature (C)")
print(MaxTemp_Plot)

#Look for NA values in data and remove
summary(Daily_High_Summer$value)
Clean_MaxTemp_Summer <- 
  Daily_High %>% 
  mutate(Temp_Clean = zoo::na.approx(value))
summary(Clean_MaxTemp_Summer)

#Filter for date and NA omitted Temp
Max_Temp_Summer <- Clean_MaxTemp_Summer%>%
  select(date, Temp_Clean)
summary(Max_Temp_Summer)

#Create Time series object and decompose

Daily_High_Summer_ts <- ts(Max_Temp_Summer$Temp_Clean, start = c(2012,04,01), frequency = 183)
Daily_High_Summer_decomp <- stl(Daily_High_Summer_ts,s.window = "periodic")
plot(Daily_High_decomp)

Daily_Temp_Trend_Summer <- Kendall::SeasonalMannKendall(Daily_High_Summer_ts)
summary(Daily_Temp_Trend_Summer)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components_Summer <- as.data.frame(Daily_High_Summer_decomp$time.series[,1:3])

Daily_Components_Summer <- mutate(Daily_Components_Summer,
        Temp_C = Max_Temp$Temp_Clean,     
        Date = Max_Temp$date)

TempSeasonAdj_Summer <- Daily_Components_Summer %>%
  mutate(Subtract.Season = Daily_Components_Summer$Temp_C - Daily_Components_Summer$seasonal)
summary(TempSeasonAdj_Summer)

NonSeasonal_Temp_Trend_Summer <- Kendall::MannKendall(TempSeasonAdj_Summer$Subtract.Season)
summary(NonSeasonal_Temp_Trend_Summer)
```

##### Ft Jackson Summer Season WBGT Time Series Trend Analysis
```{r Fort Jackson Summer WBGT Time Series}
### Wet bulb temperature April - September
#Filter for April-September
Jackson_Summer_WBT <- Jackson_Wrangle_WBT %>%
  filter(MO== 4 | MO== 5 | MO== 6 | MO== 7 | MO== 8 | MO==9 )
Jackson_Summer_WBT$date <- as.Date(Jackson_Summer_WBT$date, format = "%y/%m/%d")

#Group by date and find max daily temperature
Daily_High_WBT <- Jackson_Summer_WBT %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (WBGTC)) %>% 
  as.data.frame()
#Plot max temperatures over time
MaxWBTG_Plot <- ggplot(Daily_High_WBT, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Max Wet Bulb Over Time")+
  xlab("Time (Days)") + ylab("Wet Bulb Globe Temperature")
print(MaxWBTG_Plot)

#Look for NA values in data and remove
summary(Daily_High$value)
Clean_WetBulb <- 
  Daily_High_WBT %>% 
  mutate(WBGTC_Clean = zoo::na.approx(value))
summary(Clean_WetBulb)

#Filter for date and NA omitted Temp
Max_WetBulb <- Clean_WetBulb%>%
  select(date, WBGTC_Clean)
summary(Max_WetBulb)

#Create Time series object and decompose

Daily_High_ts <- ts(Max_WetBulb$WBGTC_Clean, start = c(2012,04,01), frequency = 183)
Daily_High_decomp <- stl(Daily_High_ts,s.window = "periodic")
plot(Daily_High_decomp)

Daily_WetBulb_Trend <- Kendall::SeasonalMannKendall(Daily_High_ts)
summary(Daily_WetBulb_Trend)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components <- as.data.frame(Daily_High_decomp$time.series[,1:3])

Daily_Components <- mutate(Daily_Components,
        WBGTC = Max_WetBulb$WBGTC_Clean,     
        Date = Max_WetBulb$date)

WetBulb_SeasonAdj <- Daily_Components %>%
  mutate(Subtract.Season = Daily_Components$WBGTC - Daily_Components$seasonal)
summary(WetBulb_SeasonAdj)

NonSeasonal_WetBulb_Trend <- Kendall::MannKendall(WetBulb_SeasonAdj$Subtract.Season)
summary(NonSeasonal_WetBulb_Trend)

```

```{r Fort Sill, Benning, and Leonard Wood April-Sep Time Series, include=FALSE}
###Summmer Temperature
#Fort Sill Summer Temperature
#Filter for April-September
Summer_KFSI <- KFSI_Wrangle %>%
  filter(Month== 4 | Month== 5 | Month== 6 | Month== 7 | Month== 8 | Month==9 )
Summer_KFSI$date <- as.Date(Summer_KFSI$date, format = "%y/%m/%d")
KFSI_Wrangle_Update <- Summer_KFSI %>%
  select(date, Temp_C)

#Group by date and find max daily temperature
Daily_High_KFSI <- KFSI_Wrangle_Update %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (Temp_C)) %>% 
  as.data.frame()
#Plot max temperatures over time
KFSI_MaxTemp_Plot <- ggplot(Daily_High_KFSI, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Max Temperatures Over Time")+
  xlab("Time (Days)") + ylab("Temperature (C)")
print(KFSI_MaxTemp_Plot)

#Look for NA values in data and remove
summary(Daily_High_KFSI$value)
KFSI_Filtered_Date <- Daily_High_KFSI %>%
  filter(between(date, as.Date("2012-04-01"), as.Date("2022-09-30")))
#Estimate NA values and filter for date and temperature
Clean_MaxTemp_KSFI <- 
  KFSI_Filtered_Date %>% 
  mutate(Temp_Clean = zoo::na.approx(value))
summary(Clean_MaxTemp_KSFI)
Clean_MaxTemp_KSFI <- Clean_MaxTemp_KSFI %>%
  select(date,Temp_Clean)
summary(Clean_MaxTemp_KSFI)


#Create Time series object and decompose
Daily_High_KFSI_ts <- ts(Clean_MaxTemp_KSFI$Temp_Clean, start = c(2012,04,01), frequency = 183)
Daily_High_KFSI_decomp <- stl(Daily_High_KFSI_ts,s.window = "periodic")
plot(Daily_High_KFSI_ts)
#Run seasonal Mann Kendall Test
Daily_Temp_Trend_KFSI <- Kendall::SeasonalMannKendall(Daily_High_KFSI_ts)
summary(Daily_Temp_Trend_KFSI)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components_KFSI <- as.data.frame(Daily_High_KFSI_decomp$time.series[,1:3])
#Create data frame with date, max temp, and daily components
Daily_Components_KFSI <- mutate(Daily_Components_KFSI,
        Temp_C = Clean_MaxTemp_KSFI$Temp_Clean,     
        Date = Clean_MaxTemp_KSFI$date)
#Subtract seasonality 
TempSeasonAdj_KFSI <- Daily_Components_KFSI %>%
  mutate(Subtract.Season = Daily_Components_KFSI$Temp_C - Daily_Components_KFSI$seasonal)
summary(TempSeasonAdj_KFSI)
#Run Mann Kendall test
NonSeasonal_Temp_Trend_KFSI <- Kendall::MannKendall(TempSeasonAdj_KFSI$Subtract.Season)
summary(NonSeasonal_Temp_Trend_KFSI)


###Fort Benning Summer Temperature
#Filter for April-September
Summer_KLSF <- KLSF_Wrangle %>%
  filter(Month== 4 | Month== 5 | Month== 6 | Month== 7 | Month== 8 | Month==9 )
Summer_KLSF$date <- as.Date(Summer_KLSF$date, format = "%y/%m/%d")
KLSF_Wrangle_Update <- Summer_KLSF %>%
  select(date, Temp_C)

#Group by date and find max daily temperature
Daily_High_KLSF <- KLSF_Wrangle_Update %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (Temp_C)) %>% 
  as.data.frame()
#Plot max temperatures over time
KLSF_MaxTemp_Plot <- ggplot(Daily_High_KLSF, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Max Temperatures Over Time")+
  xlab("Time (Days)") + ylab("Temperature (C)")
print(KLSF_MaxTemp_Plot)

#Look for NA values in data and remove
summary(Daily_High_KLSF$value)
KLSF_Filtered_Date <- Daily_High_KLSF %>%
  filter(between(date, as.Date("2012-04-01"), as.Date("2022-09-30")))
#Estimate NA Dates
Clean_MaxTemp_KLSF <- 
  KLSF_Filtered_Date %>% 
  mutate(Temp_Clean = zoo::na.approx(value))
summary(Clean_MaxTemp_KLSF)
#Select Temperature and date columns 
Clean_MaxTemp_KLSF <- Clean_MaxTemp_KLSF %>%
  select(date,Temp_Clean)
summary(Clean_MaxTemp_KLSF)

#Create Time series object and decompose

Daily_High_KLSF_ts <- ts(Clean_MaxTemp_KLSF$Temp_Clean, start = c(2012,04,01), frequency = 183)
Daily_High_KLSF_decomp <- stl(Daily_High_KLSF_ts,s.window = "periodic")
plot(Daily_High_KLSF_ts)
#Run seasonal Mann Kendall
Daily_Temp_Trend_KLSF <- Kendall::SeasonalMannKendall(Daily_High_KLSF_ts)
summary(Daily_Temp_Trend_KLSF)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components_KLSF <- as.data.frame(Daily_High_KLSF_decomp$time.series[,1:3])
#Create data frame with components
Daily_Components_KLSF <- mutate(Daily_Components_KLSF,
        Temp_C = Clean_MaxTemp_KLSF$Temp_Clean,     
        Date = Clean_MaxTemp_KLSF$date)
#Subtract Seasonality
TempSeasonAdj_KLSF <- Daily_Components_KLSF %>%
  mutate(Subtract.Season = Daily_Components_KLSF$Temp_C - Daily_Components_KLSF$seasonal)
summary(TempSeasonAdj_KLSF)
#Run Mann Kendall Test
NonSeasonal_Temp_Trend_KLSF <- Kendall::MannKendall(TempSeasonAdj_KLSF$Subtract.Season)
summary(NonSeasonal_Temp_Trend_KLSF)


###Fort Leonard Wood Summer Temperature
#Filter for April to September
Summer_KTBN <- KTBN_Wrangle %>%
  filter (Month== 4 | Month== 5 | Month== 6 | Month== 7 | Month== 8 | Month==9) 
Summer_KTBN$date <- as.Date(Summer_KTBN$date, format = "%y/%m/%d")
KTBN_Wrangle_Update <- Summer_KTBN %>%
  select(date, Temp_C)

#Group by date and find max daily temperature
Daily_High_KTBN <- KTBN_Wrangle_Update %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (Temp_C)) %>% 
  as.data.frame()
#Plot max temperatures over time
KTBN_MaxTemp_Plot <- ggplot(Daily_High_KTBN, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Max Temperatures Over Time")+
  xlab("Time (Days)") + ylab("Temperature (C)")
print(KTBN_MaxTemp_Plot)

#Look for NA values in data and remove
summary(Daily_High_KTBN$value)
KTBN_Filtered_Date <- Daily_High_KTBN %>%
  filter(between(date, as.Date("2012-04-01"), as.Date("2022-09-30")))

Clean_MaxTemp_KTBN <- 
  KTBN_Filtered_Date %>% 
  mutate(Temp_Clean = zoo::na.approx(value))
summary(Clean_MaxTemp_KTBN)

Clean_MaxTemp_KTBN <- Clean_MaxTemp_KTBN %>%
    select(date,Temp_Clean)
summary(Clean_MaxTemp_KTBN)

#Create Time series object and decompose

Daily_High_KTBN_ts <- ts(Clean_MaxTemp_KTBN$Temp_Clean, start = c(2012,04,01), frequency = 183)
Daily_High_KTBN_decomp <- stl(Daily_High_KTBN_ts,s.window = "periodic")
plot(Daily_High_KTBN_ts)

Daily_Temp_Trend_KTBN <- Kendall::SeasonalMannKendall(Daily_High_KTBN_ts)
summary(Daily_Temp_Trend_KTBN)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components_KTBN <- as.data.frame(Daily_High_KTBN_decomp$time.series[,1:3])

Daily_Components_KTBN <- mutate(Daily_Components_KTBN,
        Temp_C = Clean_MaxTemp_KTBN$Temp_Clean,     
        Date = Clean_MaxTemp_KTBN$date)

TempSeasonAdj_KTBN <- Daily_Components_KTBN %>%
  mutate(Subtract.Season = Daily_Components_KTBN$Temp_C - Daily_Components_KTBN$seasonal)
summary(TempSeasonAdj_KTBN)

NonSeasonal_Temp_Trend_KTBN <- Kendall::MannKendall(TempSeasonAdj_KTBN$Subtract.Season)
summary(NonSeasonal_Temp_Trend_KTBN)

### WBT April-Sep Time Series
### Fort Sill
#Filter for April-September
Summer_KFSI <- KFSI_Wrangle_WBT %>%
  filter(Month== 4 | Month== 5 | Month== 6 | Month== 7 | Month== 8 | Month==9 )
Summer_KFSI$date <- as.Date(Summer_KFSI$date, format = "%y/%m/%d")
KFSI_Wrangle_Update <- Summer_KFSI %>%
  select(date, Derived.Wet.Bulb.Globe.Temperature..F.)

#Group by date and find max daily temperature
Daily_High_KFSI <- KFSI_Wrangle_Update %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (Derived.Wet.Bulb.Globe.Temperature..F.)) %>% 
  as.data.frame()
#Plot max wet bulb temperatures over time
KFSI_Max_WetBulb_Plot <- ggplot(Daily_High_KFSI, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Max Wet Bulb Temperatures Over Time")+
  xlab("Time (Days)") + ylab("Wet Bulb (F)")
print(KFSI_Max_WetBulb_Plot)

#Look for NA values in data and remove. Create date range for avalaible data
summary(Daily_High_KFSI$value)
KFSI_Filtered_Date <- Daily_High_KFSI %>%
  filter(between(date, as.Date("2012-01-10"), as.Date("2022-09-30")))
#estimate NA values by average
Clean_Max_WetBulb_KSFI <- 
  KFSI_Filtered_Date %>% 
  mutate(Wet_Bulb = zoo::na.approx(value))
summary(Clean_Max_WetBulb_KSFI)
Clean_Max_WetBulb_KSFI <- Clean_Max_WetBulb_KSFI %>%
  select(date,Wet_Bulb)
summary(Clean_Max_WetBulb_KSFI)


#Create Time series object and decompose

Daily_High_KFSI_ts <- ts(Clean_Max_WetBulb_KSFI$Wet_Bulb, start = c(2012,04,01), frequency = 183)
Daily_High_KFSI_decomp <- stl(Daily_High_KFSI_ts,s.window = "periodic")
plot(Daily_High_KFSI_ts)
#Run seasonal Mann Kendall
Daily_Temp_Trend_KFSI <- Kendall::SeasonalMannKendall(Daily_High_KFSI_ts)
summary(Daily_Temp_Trend_KFSI)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components_KFSI <- as.data.frame(Daily_High_KFSI_decomp$time.series[,1:3])
#Create data frame with components, wet bulb temp, and date
Daily_Components_KFSI <- mutate(Daily_Components_KFSI,
        Wet_Bulb_F = Clean_Max_WetBulb_KSFI$Wet_Bulb,     
        Date = Clean_Max_WetBulb_KSFI$date)
#Subtract seasonality from wet bulb temperature data
TempSeasonAdj_KFSI <- Daily_Components_KFSI %>%
  mutate(Subtract.Season = Daily_Components_KFSI$Wet_Bulb_F - Daily_Components_KFSI$seasonal)
summary(TempSeasonAdj_KFSI)
#Run Mann Kendall Test
NonSeasonal_Temp_Trend_KFSI <- Kendall::MannKendall(TempSeasonAdj_KFSI$Subtract.Season)
summary(NonSeasonal_Temp_Trend_KFSI)


###Fort Benning 
#Filter April-Septmeber
Summer_KLSF <- KLSF_Wrangle_WBT %>%
  filter(Month== 4 | Month== 5 | Month== 6 | Month== 7 | Month== 8 | Month==9 )
Summer_KLSF$date <- as.Date(Summer_KLSF$date, format = "%y/%m/%d")
KLSF_Wrangle_Update <- Summer_KLSF %>%
  select(date, Derived.Wet.Bulb.Globe.Temperature..F.)

#Group by date to remove blank rows and find max daily temperature
Daily_High_KLSF <- KLSF_Wrangle_Update %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (Derived.Wet.Bulb.Globe.Temperature..F.)) %>% 
  as.data.frame()
#Plot max wet bulb temperatures over time
KLSF_Max_Wet_Bulb_Plot <- ggplot(Daily_High_KLSF, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Max Wet Bulb Temperatures Over Time")+
  xlab("Time (Days)") + ylab("Wet Bulb (F)")
print(KLSF_Max_Wet_Bulb_Plot)

#Look for NA values in data and set date range
summary(Daily_High_KLSF$value)
KLSF_Filtered_Date <- Daily_High_KLSF %>%
  filter(between(date, as.Date("2012-04-01"), as.Date("2022-09-30")))
#remove NA values by approximating value
Clean_Max_WetBulb_KLSF <- 
  KLSF_Filtered_Date %>% 
  mutate(Wet_Bulb = zoo::na.approx(value))
summary(Clean_Max_WetBulb_KLSF)
#Select wet bulb and date columns
Clean_Max_WetBulb_KLSF <- Clean_Max_WetBulb_KLSF %>%
  select(date,Wet_Bulb)
summary(Clean_Max_WetBulb_KLSF)

#Create Time series object and decompose

Daily_High_KLSF_ts <- ts(Clean_Max_WetBulb_KLSF$Wet_Bulb, start = c(2012,04,01), frequency = 183)
Daily_High_KLSF_decomp <- stl(Daily_High_KLSF_ts,s.window = "periodic")
plot(Daily_High_KLSF_ts)
#Run seasonal Mann Kendall test
Daily_Temp_Trend_KLSF <- Kendall::SeasonalMannKendall(Daily_High_KLSF_ts)
summary(Daily_Temp_Trend_KLSF)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components_KLSF <- as.data.frame(Daily_High_KLSF_decomp$time.series[,1:3])
#Create data frame for components
Daily_Components_KLSF <- mutate(Daily_Components_KLSF,
        Wet_Bulb = Clean_Max_WetBulb_KLSF$Wet_Bulb,     
        Date = Clean_Max_WetBulb_KLSF$date)
#Subtract seasonality from wet bulb data
TempSeasonAdj_KLSF <- Daily_Components_KLSF %>%
  mutate(Subtract.Season = Daily_Components_KLSF$Wet_Bulb - Daily_Components_KLSF$seasonal)
summary(TempSeasonAdj_KLSF)
#Run Mann Kendall test
NonSeasonal_Temp_Trend_KLSF <- Kendall::MannKendall(TempSeasonAdj_KLSF$Subtract.Season)
summary(NonSeasonal_Temp_Trend_KLSF)


###Fort Leonard
#Filter April-September
Summer_KTBN <- KTBN_Wrangle_WBT %>%
  filter(Month== 4 | Month== 5 | Month== 6 | Month== 7 | Month== 8 | Month==9 )
Summer_KTBN$date <- as.Date(Summer_KTBN$date, format = "%y/%m/%d")
KTBN_Wrangle_Update <- Summer_KTBN %>%
  select(date, Derived.Wet.Bulb.Globe.Temperature..F.)

#Group by date and find max daily wet bulb temperature
Daily_High_KTBN <- KTBN_Wrangle_Update %>%
  group_by(date) %>% 
  dplyr::summarize(value = max (Derived.Wet.Bulb.Globe.Temperature..F.)) %>% 
  as.data.frame()
#Plot max wet bulb temperatures over time
KTBN_Max_WetBulb_Plot <- ggplot(Daily_High_KTBN, aes(x = date, y = value)) +
  geom_line()+
  geom_smooth(method=lm, col= 'red')+
 ggtitle("Wet Bulb Temperatures Over Time")+
  xlab("Time (Days)") + ylab("Wet Bulb (F)")
print(KTBN_Max_WetBulb_Plot)

#Look for NA values in data and remove
summary(Daily_High_KTBN$value)
KTBN_Filtered_Date <- Daily_High_KTBN %>%
  filter(between(date, as.Date("2012-04-01"), as.Date("2022-09-30")))
#estimate max values to remove NA
Clean_Max_WetBulb_KTBN <- 
  KTBN_Filtered_Date %>% 
  mutate(Wet_Bulb = zoo::na.approx(value))
summary(Clean_Max_WetBulb_KTBN)
#Select wet bulb and date data columns
Clean_Max_WetBulb_KTBN <- Clean_Max_WetBulb_KTBN %>%
    select(date,Wet_Bulb)
summary(Clean_Max_WetBulb_KTBN)

#Create Time series object and decompose

Daily_High_KTBN_ts <- ts(Clean_Max_WetBulb_KTBN$Wet_Bulb, start = c(2012,04,01), frequency = 183)
Daily_High_KTBN_decomp <- stl(Daily_High_KTBN_ts,s.window = "periodic")
plot(Daily_High_KTBN_ts)
#Run seasonal Mann Kendall
Daily_WetBulb_Trend_KTBN <- Kendall::SeasonalMannKendall(Daily_High_KTBN_ts)
summary(Daily_WetBulb_Trend_KTBN)

#Subtract seasonality and run seasonally adjusted Mann Kendall
Daily_Components_KTBN <- as.data.frame(Daily_High_KTBN_decomp$time.series[,1:3])
#make data frame with seasonal component, date, and wet bulb
Daily_Components_KTBN <- mutate(Daily_Components_KTBN,
        Wet_Bulb = Clean_Max_WetBulb_KTBN$Wet_Bulb,     
        Date = Clean_Max_WetBulb_KTBN$date)
#Subtract seasonality
TempSeasonAdj_KTBN <- Daily_Components_KTBN %>%
  mutate(Subtract.Season = Daily_Components_KTBN$Wet_Bulb - Daily_Components_KTBN$seasonal)
summary(TempSeasonAdj_KTBN)
#Run Mann Kendall
NonSeasonal_Wet_Bulb_Trend_KTBN <- Kendall::MannKendall(TempSeasonAdj_KTBN$Subtract.Season)
summary(NonSeasonal_Wet_Bulb_Trend_KTBN)
```

## Exploratory Analysis Question #1b: Are there trends in the number of "Black Flag" and "Red Flag" days at the installations?

"Black Flag" refers to days when the local WBGT is \>90 Fahrenheit. At this temperature, training on military installations may be significantly curtailed. "Red Flag" days refer to WBGT between 88 and 90 degrees Fahrenheit. During Red flag conditions, training may be modified, and preventative measures to protect from heat illness are recommended. To determine the number of days and trends for "Black" and "Red" flag days, a table "Hazardous_Days_Limits" was created with the standard for each color level at corresponding temperature. Within this table the mutate function was used to create a Celsius column from the provided Fahrenheit data.

```{r,include=FALSE}
#Load the temperature thresholds
HD_First_Column <- c("Green","Yellow","Red","Black")
HD_Temp_Min <- c(82,85,88,90)
HD_Temp_Min <- as.numeric(HD_Temp_Min)
HD_Temp_Min <- signif(HD_Temp_Min,digits=2)
HD_Temp_Max <- c(84.999,87.999,89.999,104)
HD_Temp_Max <- as.numeric(HD_Temp_Max)
HD_Temp_Max <- signif(HD_Temp_Max,digits=2)
Hazardous_Days_Limits <- cbind(HD_First_Column,HD_Temp_Min,HD_Temp_Max)
Hazardous_Days_Limits <- as.data.frame(Hazardous_Days_Limits)
Hazardous_Days_Limits$HD_Temp_Min <- as.integer(Hazardous_Days_Limits$HD_Temp_Min)
Hazardous_Days_Limits$HD_Temp_Max <- as.integer(Hazardous_Days_Limits$HD_Temp_Max)
```

```{r, include=FALSE}
Hazardous_Days_Limits <-  Hazardous_Days_Limits%>%
  mutate(HD_Temp_Min_C = (HD_Temp_Min-32)*(5/9))%>%
  mutate(HD_Temp_Max_C = (HD_Temp_Max-32)*(5/9))%>%
  rename(Flag_Color=HD_First_Column, Temp_Limit_Max_F=HD_Temp_Max,Temp_Limit_Min_F=HD_Temp_Min, Temp_Limit_Min_C=HD_Temp_Min_C, Temp_Limit_Max_C=HD_Temp_Max_C)
```

```{r}
Hazardous_Days_Limits
```

The input data used to count the number of Black and Red flag days was an output of the summer time series data in order to explore trends during the warmest periods of the year when the effects of high heat are greatest. This limits the months counted to April through September of each year. A separate analysis was conducted using the full year and returned a greater number of days per year in the Red and Black category, showing there are a high heat days outside the window considered in this analysis. However, discussion and comparison of the differences is outside the scope of this analysis.

Data filtering provided the Black flag days and Red flag + Black flag days subsets. Red flag days were not considered as a subset independent of Black flag days because any day that exceeded WBGT >90F (i.e. a Black flag day) also was a Red flag day, having first passed through this temperature range (88-90F). Furthermore, any training restrictions or modification or precautions put in place during a Red flag day are also implemented on Black flag days. This provided two data subsets referred to as "High Heat days": all high heat days at WBGT >=88F and the hottest high heat days in the Black flag category, >=90F.

```{r, include=FALSE }
#This code chunk is shown as the representative installation. The other three installations also received the same treatment to bin the days in each "flag catagory".
#Count number of days in each flag threshold. 
FJSC_Total.BlackFlag <- sum(Max_WetBulb$WBGTC_Clean >= Hazardous_Days_Limits$Temp_Limit_Min_C[4])
FJSC_Total.RedFlag <- sum(Max_WetBulb$WBGTC_Clean >= Hazardous_Days_Limits$Temp_Limit_Min_C[3] & Max_WetBulb$WBGTC_Clean < Hazardous_Days_Limits$Temp_Limit_Min_C[4])
FJSC_Total.YellowFlag <- sum(Max_WetBulb$WBGTC_Clean >= Hazardous_Days_Limits$Temp_Limit_Min_C[2] & Max_WetBulb$WBGTC_Clean < Hazardous_Days_Limits$Temp_Limit_Min_C[3])
FJSC_Total.GreenFlag <- sum(Max_WetBulb$WBGTC_Clean >= Hazardous_Days_Limits$Temp_Limit_Min_C[1] & Max_WetBulb$WBGTC_Clean < Hazardous_Days_Limits$Temp_Limit_Min_C[2])
#FJSC_Total.NoFlag <- sum(Max_WetBulb$WBGTC_Clean < Hazardous_Days_Limits$Temp_Limit_Min_C[2])
FJSC_Total.AllFlags <- rbind(FJSC_Total.BlackFlag,FJSC_Total.RedFlag,FJSC_Total.YellowFlag,FJSC_Total.GreenFlag)
FJSC_Total.AllFlags <- as.data.frame(FJSC_Total.AllFlags)
FJSC_Total.AllFlags <- cbind(Hazardous_Days_Limits[1],FJSC_Total.AllFlags)
FJSC_Total.AllFlags$Flag_Color <- rev(FJSC_Total.AllFlags$Flag_Color) 
#reverse the color order to match the correct number of days
FJSC_Total.AllFlags <- rename(FJSC_Total.AllFlags, Number_Days=V1)
FJSC_Total.AllFlags <- FJSC_Total.AllFlags%>%
    mutate(Installation = "FJSC")%>%
  select(Installation,Flag_Color,Number_Days)
view(FJSC_Total.AllFlags)
```

```{r, include=FALSE}
#ALL OTHER INSTALLATIONS FLAG DAY COUNT

##FORT SILL, OK
FSOK_Clean_C <- Clean_Max_WetBulb_KSFI%>%
  mutate(Wet_Bulb_C = (Wet_Bulb-32)*(5/9))

FSOK_Total.BlackFlag <- sum(FSOK_Clean_C$Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[4])
FSOK_Total.RedFlag <- sum(FSOK_Clean_C$Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[3] & FSOK_Clean_C$Wet_Bulb_C < Hazardous_Days_Limits$Temp_Limit_Min_C[4])
FSOK_Total.YellowFlag <- sum(FSOK_Clean_C$Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[2] & FSOK_Clean_C$Wet_Bulb_C < Hazardous_Days_Limits$Temp_Limit_Min_C[3])
FSOK_Total.GreenFlag <- sum(FSOK_Clean_C$Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[1] & FSOK_Clean_C$Wet_Bulb_C < Hazardous_Days_Limits$Temp_Limit_Min_C[2])
#FSOK_Total.NoFlag <- sum(FSOK_Clean_C$Wet_Bulb_C < Hazardous_Days_Limits$Temp_Limit_Min_C[2])
FSOK_Total.AllFlags <- rbind(FSOK_Total.BlackFlag,FSOK_Total.RedFlag,FSOK_Total.YellowFlag,FSOK_Total.GreenFlag)
FSOK_Total.AllFlags <- as.data.frame(FSOK_Total.AllFlags)%>%
  cbind(Hazardous_Days_Limits[1],FSOK_Total.AllFlags)
FSOK_Total.AllFlags$Flag_Color <-  rev(FSOK_Total.AllFlags$Flag_Color) 
#reverse the color order to match the correct number of days
FSOK_Total.AllFlags <- rename(FSOK_Total.AllFlags, Number_Days=V1)
FSOK_Total.AllFlags <-  FSOK_Total.AllFlags%>%
    mutate(Installation = "FSOK")%>%
  select(Installation,Flag_Color,Number_Days)
#view(FSOK_Total.AllFlags)


##FORT BENNING, GA
FBGA_Clean_C <- Clean_Max_WetBulb_KLSF%>%
  mutate(Wet_Bulb_C = (Wet_Bulb-32)*(5/9))

FBGA_Total.BlackFlag <- sum(FBGA_Clean_C$Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[4])
FBGA_Total.RedFlag <- sum(FBGA_Clean_C$Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[3] & FBGA_Clean_C$Wet_Bulb_C < Hazardous_Days_Limits$Temp_Limit_Min_C[4])
FBGA_Total.YellowFlag <- sum(FBGA_Clean_C$Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[2] & FBGA_Clean_C$Wet_Bulb_C < Hazardous_Days_Limits$Temp_Limit_Min_C[3])
FBGA_Total.GreenFlag <- sum(FBGA_Clean_C$Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[1] & FBGA_Clean_C$Wet_Bulb_C < Hazardous_Days_Limits$Temp_Limit_Min_C[2])
#FBGA_Total.NoFlag <- sum(FBGA_Clean_C$Wet_Bulb_C < Hazardous_Days_Limits$Temp_Limit_Min_C[2])
FBGA_Total.AllFlags <- rbind(FBGA_Total.BlackFlag,FBGA_Total.RedFlag,FBGA_Total.YellowFlag,FBGA_Total.GreenFlag)
FBGA_Total.AllFlags <- as.data.frame(FBGA_Total.AllFlags)%>%
  cbind(Hazardous_Days_Limits[1],FBGA_Total.AllFlags)
FBGA_Total.AllFlags$Flag_Color <-  rev(FBGA_Total.AllFlags$Flag_Color) 
#reverse the color order to match the correct number of days
FBGA_Total.AllFlags <- rename(FBGA_Total.AllFlags, Number_Days=V1)
FBGA_Total.AllFlags <-  FBGA_Total.AllFlags%>%
    mutate(Installation = "FBGA")%>%
  select(Installation,Flag_Color,Number_Days)
#view(FBGA_Total.AllFlags)

##FT LEONARD WOOD, MO
FLW_Clean_C <- Clean_Max_WetBulb_KTBN%>%
  mutate(Wet_Bulb_C = (Wet_Bulb-32)*(5/9))
FLW_Total.BlackFlag <- sum(FLW_Clean_C$Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[4])
FLW_Total.RedFlag <- sum(FLW_Clean_C$Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[3] & FLW_Clean_C$Wet_Bulb_C < Hazardous_Days_Limits$Temp_Limit_Min_C[4])
FLW_Total.YellowFlag <- sum(FLW_Clean_C$Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[2] & FLW_Clean_C$Wet_Bulb_C < Hazardous_Days_Limits$Temp_Limit_Min_C[3])
FLW_Total.GreenFlag <- sum(FLW_Clean_C$Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[1] & FLW_Clean_C$Wet_Bulb_C < Hazardous_Days_Limits$Temp_Limit_Min_C[2])
#FLW_Total.NoFlag <- sum(FLW_Clean_C$Wet_Bulb_C < Hazardous_Days_Limits$Temp_Limit_Min_C[2])
FLW_Total.AllFlags <- rbind(FLW_Total.BlackFlag,FLW_Total.RedFlag,FLW_Total.YellowFlag,FLW_Total.GreenFlag)
FLW_Total.AllFlags <- as.data.frame(FLW_Total.AllFlags)%>%
  cbind(Hazardous_Days_Limits[1],FLW_Total.AllFlags)
FLW_Total.AllFlags$Flag_Color <-  rev(FLW_Total.AllFlags$Flag_Color) 
#reverse the color order to match the correct number of days
FLW_Total.AllFlags <- rename(FLW_Total.AllFlags, Number_Days=V1)
FLW_Total.AllFlags <-  FLW_Total.AllFlags%>%
  mutate(Installation = "FLW")%>%
  select(Installation,Flag_Color,Number_Days)
#view(FLW_Total.AllFlags)
```

The number of days at each "Color Flag" condition was consolidated to the following table:

```{r, Flag Day Counts at all installations }
##CREATE FINAL TABLE WITH ALL FLAG DAYS
All_Installations.AllFlags <- rbind(FJSC_Total.AllFlags,FBGA_Total.AllFlags,FSOK_Total.AllFlags,FLW_Total.AllFlags)
All_Installations.AllFlags
```

### Trend Alanysis for Black and Red Flag Days
Trend analysis on the number of Black and Black+Red flag days was done using the filtered data for the summer months, April through September.
```{r}
#Ft Jackson wrangling for Red and Black flag trends, shown as representative code for all installations
FJSC_B_R_subset2 <- Max_WetBulb%>%
  subset(WBGTC_Clean >= Hazardous_Days_Limits$Temp_Limit_Min_C[3])%>%
  mutate(month = month(date))%>%
  mutate(year=year(date))%>%
  group_by(year)%>%
  count(year)%>%
  rename(FJSC_Count_Days_Red_and_Above=n)
view(FJSC_B_R_subset2)
```

```{r, include=FALSE}
#other three installations, not to display in final document
FSOK_B_R_subset2 <- FSOK_Clean_C%>%
  subset(Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[3])%>%
  mutate(month = month(date))%>%
  mutate(year=year(date))%>%
  group_by(year)%>%
  count(year)%>%
  rename(FSOK_Count_Days_Red_and_Above=n)

FBGA_B_R_subset2 <- FBGA_Clean_C%>%
  subset(Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[3])%>%
  mutate(month = month(date))%>%
  mutate(year=year(date))%>%
  group_by(year)%>%
  count(year)%>%
  rename(FBGA_Count_Days_Red_and_Above=n)

FLW_B_R_subset2 <- FLW_Clean_C%>%
  subset(Wet_Bulb_C >= Hazardous_Days_Limits$Temp_Limit_Min_C[3])%>%
  mutate(month = month(date))%>%
  mutate(year=year(date))%>%
  group_by(year)%>%
  count(year)%>%
  rename(FLW_Count_Days_Red_and_Above=n)
view(FLW_B_R_subset2)

#creating combined "Red and Black" subset
R_B_subset2 <- full_join(FSOK_B_R_subset2,FJSC_B_R_subset2)
R_B_subset2 <- full_join(FBGA_B_R_subset2,R_B_subset2)
R_B_subset2 <- full_join(FLW_B_R_subset2,R_B_subset2)
#R_B_subset2 <- R_B_subset2
  #mutate('date' = make_date(year = year, month = month))%>%
  #filter(month == 6||month==7||month==8)%>%#filters for June, July, August
view(R_B_subset2)
```

```{r, include=FALSE}
R_B_subset_plot2 <- ggplot(R_B_subset2,aes(x=year))+
    ylab("Summer Season APRIL-SEPTEMBER \nDays At RED or Above WBGT Conditions")+
  scale_x_continuous(name="Year",n.breaks=11)+
  theme(axis.text.x = element_text(size=7, angle=45), plot.title=element_text(hjust=0.5, vjust=0.5, face='bold'))+ 
  geom_point(aes(y=FLW_Count_Days_Red_and_Above),color='black',shape=0)+
  geom_line(aes(y=FLW_Count_Days_Red_and_Above),color='red')+
  geom_smooth(aes(y=FLW_Count_Days_Red_and_Above,color='FLW_Count_Days_Red_and_Above'),se=FALSE)+
  geom_point(aes(y=FBGA_Count_Days_Red_and_Above),color='black',shape=1)+
  geom_line(aes(y=FBGA_Count_Days_Red_and_Above),color='blue')+
  geom_smooth(aes(y=FBGA_Count_Days_Red_and_Above,color='FBGA_Count_Days_Red_and_Above'), se=FALSE, color='blue')+
  geom_point(aes(y=FSOK_Count_Days_Red_and_Above),color='black',shape=2)+
  geom_line(aes(y=FSOK_Count_Days_Red_and_Above),color='yellow')+
  geom_smooth(aes(y=FSOK_Count_Days_Red_and_Above,color='FSOK_Count_Days_Red_and_Above'), se=FALSE, color='yellow')+
  geom_point(aes(y=FJSC_Count_Days_Red_and_Above),color='black',shape=4)+
  geom_line(aes(y=FJSC_Count_Days_Red_and_Above),color='white')+
  geom_smooth(aes(y=FJSC_Count_Days_Red_and_Above,color='FJSC_Count_Days_Red_and_Above'), se=FALSE,color='white')+
  scale_color_manual(name='Installations',
                     breaks=c('FBGA','FSOK','FJSC','FLW'),
                     values=c('FBGA'='blue','FJSC'='white','FSOK'='yellow','FLW'='red'))

 
R_B_subset_plot2
```

To explore the trend analysis for the number of Black flag days and Red flag + Black flag days, data was wrangled by grouping by (year, month) and then counting the number of days with WBGT value greater than or equal to the lower limit for Red flag day (>= 88F). The results were first visually inspected with the following graph:

```{r, collpase=TRUE}
R_B_subset_plot2
```

The function "geom_smooth" was used to fit a line to the data points and assist in visual trend analysis, as viewed in the graph above. There is no obvious trend to the number of WBGT days, either increasing or decreasing, among the installations across the decade studied. There is a slight anomaly during the years 2018 and 2019 which appear to show a higher than average number of high heat days at Ft Benning, GA and Ft Sill, OK, with the number of summertime increased heat days spiking especially at Ft Sill. There is also a peak during 2016 where all four installations appear to have experienced a higher than average number of summertime high heat days, although this phenomena is muted at Ft Leonard Wood.

To determine statistically if a correlation exists, "corrtest" was conducted between the year and the number of WBGT days.

```{r, include=FALSE}
FJSC_CorTest <- cor.test(R_B_subset2$FJSC_Count_Days_Red_and_Above,R_B_subset2$year)
FJSC_CorTest
FBGA_CorTest <- cor.test(R_B_subset2$FBGA_Count_Days_Red_and_Above,R_B_subset2$year)
FBGA_CorTest
FSOK_CorTest <- cor.test(R_B_subset2$FSOK_Count_Days_Red_and_Above,R_B_subset2$year)
FSOK_CorTest
FLW_CorTest <- cor.test(R_B_subset2$FLW_Count_Days_Red_and_Above,R_B_subset2$year)
FLW_CorTest
```

Correlation testing, using the Pearson's product-moment correlation, found no statistically significant p-values when measuring the difference in the number of days at Red flag or above and that year's summer. One limitation of this analysis is the limited degrees of freedom (df = 9) afforded by a grouping high heat days into a count by year; the data sets each covered a decade, so only ten observations were available for the correlation test (one observation a year). This data set also filtered out days with high heat before and after the six month summer season. Full year analysis, which was run for a separate project, returns slightly higher statistical fit, although well below the threshold needed to be considered "significant".

Three of the installations (Ft Benning, Ft Jackson, and Ft Sill) have positive correlations, although the 95% confidence intervals extended from negative values to positive values at all three installations. The fourth installation, Ft Leonard Wood, had a slight negative correlation, implying a reduced trend in the number of days at or above Red flag, although this correlation was also not statistically significant (p = 0.5). Interestingly, Ft Leonard Wood's negative correlation had the strongest statistical significance, with a p-value of 0.2, although this is still far from the 0.05 p-value that would allow a rejection of the null hypothesis. The results for Ft Jackson, SC and Ft Leonard Wood, MO are displayed below:

```{r, collapse=TRUE}
FJSC_CorTest
FLW_CorTest
```

## Exploratory Analysis Question #2: How many days was the temperature in each of the "Color Flag" temperature categories for each installation?

To determine the number of summer season days that each installation was in a heat category, code from the Black and Red Flag trend analysis was used. After wrangling to ensure the WBGT temperature was in degrees C and removing any rows with NAs in WBGT column, each row was compared to the "Hazardous_Days_Limits" table that was created at the start of this project.

Fort Jackson results are shown as representative of the code used at the four installations. The time period studied was the months April through September for years 2012 through 2022.

The total number of Black flag days at Ft Jackson over the time period studied was:

```{r, collapse=TRUE}
FJSC_Total.BlackFlag
```

and the total number of Black plus Red flag days was:

```{r, collapse=TRUE}
FJSC_Total.BlackFlag+FJSC_Total.RedFlag
```

The final output is the following table with Black and Red flag day numbers for each installation:

```{r, collapse=TRUE}
AllFlags_Table <- subset(All_Installations.AllFlags, Flag_Color %in% c("Black","Red"))
AllFlags_Table
```

\newpage

# Analysis

## Question 1a:

Initial linear trend analysis indicated that each of the military bases had an increasing temperature and wet bulb temperature trend from 2012-2022. To test the significance of the trend, the p-values for each test were recorded. The results of the seasonal Mann Kandell test for temperature and wet bulb temperature are summarized below.

Seasonal Mann Kendall Test p-values

Temperature: Fort Jackson- 0.18713 Fort Sill- 0.2705\
Fort Benning- 0.028973 Fort Leonard Wood- 0.40233

Wet Bulb Temperature:\
Fort Jackson- 0.011203\
Fort Sill- 0.0000025741\
Fort Benning- 0.010062 Fort Leonard Wood- 0.88571

The Mann Kendall test for temperature trends indicates that only Fort Benning has a significant increase over time. The other three locations each had p-values above 0.05, meaning the trend in temperature over time is not significant. The time series analysis for wet bulb temperature shows a different trend. The only location that did not have a significant p-value was Fort Leonard Wood. Wet bulb temperature is calculated with several climate variables. One or more of the climate variables in addition to the temperature could be contributing to the increases in significance over time.

The results of the seasonally adjusted Mann Kendall test are displayed below. They show the same trend as the previous test. For temperature, only for Benning had a significant temperature change over time. The evaluation of wet bulb temperatures showed all bases had a significant increased trend except for Leonard Wood. The limited difference between the two tests indicates that seasonality is not the most significant influence in temperature trends over time. The changes in temperature over time must be caused by some changes in the climate.

Mann Kendall Test p-values

Temperature: Fort Jackson- 0.070381 Fort Sill- 0.21843 Fort Benning- 0.0088482 Fort Leonard Wood- 0.3103

Wet Bulb Temperature:\
Fort Jackson- 0.0058262 Fort Sill- 0.00015247 Fort Benning- 0.023233 Fort Leonard Wood- 0.8534

To remove the possibility of other seasonal data altering the time series analysis results, another set of Mann Kendall tests were run on the hottest months of the year. By filtering for April to September, the temperature trends should be related to how very high temperature values are changing over time. The results of the seasonal and seasonal corrected Mann Kendall tests for temperature and wet bulb temperature are shown below.

Seasonal Mann Kendall Test p-values

Temperature: Fort Jackson- 0.6628 Fort Sill- 0.46972 Fort Benning- 0.38949 Fort Leonard Wood- 0.93088

Wet Bulb Temperature:\
Fort Jackson- 0.00021393 Fort Sill- 0.00005681 Fort Benning- 0.24171 Fort Leonard Wood- 0.40213

Mann Kendall Test p-values\
Temperature: Fort Jackson- 0.32933 Fort Sill- 0.21601 Fort Benning- 0.41984 Fort Leonard Wood- 0.89287

Wet Bulb Temperature:\
Fort Jackson- 0.00013828 Fort Sill- 0.004475 Fort Benning- 0.35493 Fort Leonard Wood- 0.20388

The warm month Mann Kendall analysis shows that over the hottest period of the year, no location has a significant p-value for temperature. The results indicate that there is not a significant increase in daily high temperatures between 2012 and 2022. The wet bulb temperature p-values for seasonal and non-seasonal do show that Forts Jackson and Sill have had increases in daily high wet bulb temperatures over the analysis period. The summer results do not indicate that Fort Benning has had a significant increase in daily high wet bulb temperatures. This contradicts the results of the previous full year analysis. These results indicate that changes in temperature outside of the warmest months of the year did influence the trends in the previous analysis and skewed the p-values.

## Question 1b:
There is no statistical significance between the number of summertime high heat days and the year during the ten year period considered for this study. p-values at all installations were >=0.5, implying a very poor fit. There is no statistically significant trend for increasing (or decreasing) high heat days for the time period studied. Within a large confidence interval, spanning negative to positive numbers, three of the installations had weak positive correlations and one of the installations (Ft Leonard Wood, MO) had a weak negative correlation.

|	| Fort Jackson, SC |Fort Benning, GA |Fort Sill, OK |Fort Leonard Wood, MO| 
|:--- |	 :---: 		| :---: 			| :---: 		| :---: | 
|Installation		 |FJSC			|FBGA		|FSOK		|FLW| 
|Correlation		| 0.269			| 0.319		| 0.330		| -0.410| 
|95% Confidence Interval| 	-0.393  0.748|  -0.347  0.771| -0.335  0.776|  -0.810  0.251|
|p-value		| 0.4224		| 0.3386	| 0.3202	| 0.2103|


The findings were surprising, given that the working hypothesis was that there is an increasing trend in the number of high heat days. 

There are several limitations to this data set and how it was analyzed. First, only the months between April and September were included in the count. This is partially because data was first wrangled to conduct trend analysis for increasing heat and WBGT, so colder months were removed. The same data was analyzed separately using a full year data set, returning higher counts for the total number of combined Black and Red flag days. For example, over the ten year period considered, Ft Benning, GA experienced 334 additional days at Black or Red flag conditions between October and March. The choice of timeframe may therefor hide an underlying trend in increasing high heat days outside the months when these days normally occur.

A second limitation is the data sets themselves. Increasing temperatures, a consequence of global warming, occur slowly. The ten year period is hypothesized to be too small a time frame to achieve statistical significance, especially considering only one weather station per installation was analyzed. This is most apparent in the correlation between high heat days and year at Ft Leonard Wood, which shows a decreasing (but not statistically significant trend). Studying ten years and grouping by year provides only 9 degrees for freedom for the correlations tests, resulting in the large confidence intervals seen at each of the installations. Confidence intervals all ranged by more than 1C and at each installation ranged from a negative to positive value.

Despite statistical analysis limitations, some trends in the number of high heat days are apparent. A hotter than average summer appeared in 2016 for three of the studied installations, with each installations except Ft Leonard Wood experiencing higher than average number of days in the Black or Red category. The year 2019 saw the greatest number of high heat days at Ft Sill and Ft Benning for the period studied, a possible indicator of an unusually warm summer. Ft Leonard Wood data is the most consistent, with a relatively steady number of high heat days in the years 2012-2016 and 2021-2022, but also four consecutive years of a lower number of high heat days (2017-2020). The consistency in number of high heat days across years at Ft Leonard Wood combined with a string of four lower than average years likely caused the weak negative correlation in number of high heat days and year.  

## Question 2:

In terms of real number of days exceeding the Black or Red flag thresholds it is clear that Ft Benning, GA experienced the most high WBGT days. For the ten years considered there were 764 days at FBGA that were > 88F WBGT during the months of April - September. Ft Sill, OK, and Ft Jackson, SC tied for the second greatest number of days under Red or Black flag conditions at 510, Although Ft Sill, OK had slightly more of the hottest Black flag days. Ft Leonard Wood, MO had the least amount of high heat training days in the study period at 230, with only 91 of these days the hottest Black flag category (less than 10 Black flag days a year during the study period).

Knowing the number of total Black and Red flag days at each installation assists long range planning efforts. Using the analysis conducted in this study, the number of days when training may be impacted during the warmer months of each year can be used to plan for the number of extra days built in to a quarterly or yearly training program. In this sense, high heat days and military training planning is analogous to elementary school districts and snow days; a set number of days are programmed into the school year to account for those days when snow closes school. It is only if the season is particularly bad and the number of actual days impacted exceeds the planned estimate (for example, snow storms exceeding snow days for school districts) that additional days need to be added to the end of the school year. 

Ft Benning having the greatest number of high heat days was expected, as it is the furthest south of all training installations considered in this study, not near a coast, and is located in the humid Southeast. The 4th National Assessment on climate change states that, although the Southeast is warming relatively slowly compared to much of the world, three of the top five large cities experiencing increases in heat wave duration and intensity are located in the Southeast. The number of nights above 75F in the Southeast has increased at roughly double the historical average, an important consideration during days-long field training exercises during which a soldier's body relies on cooler nighttime temperatures to "reset" and prepare for another hot day. High nighttime temperatures is a potential further study area using this data set.

```{r, include=FALSE}
#FSOK = Fort Sill, Oklahoma
FSOK_KFSI_sfg <- st_point(c(-98.391,34.637))
FSOK_KFSI_sfc <- st_sfc(FSOK_KFSI_sfg, crs=4326)
FSOK_KFSI_sf <- st_as_sf(FSOK_KFSI_sfc)
FSOK_KFSI_sf$Name = 'Ft Sill, OK'

#FJSC = Fort Jackson, SC
FJSC_KCUB_sfg <- st_point(c(-81.01,33.99))
FJSC_KCUB_sfc <- st_sfc(FJSC_KCUB_sfg,crs=4326)
FJSC_KCUB_sf <- st_as_sf(FJSC_KCUB_sfc)
FJSC_KCUB_sf$Name = 'Ft Jackson, SC'

#FLW = Fort Leaonard Wood, MO
FLW_KTBN_sfg <- st_point(c(-92.12,37.75))
FLW_KTBN_sfc <- st_sfc(FLW_KTBN_sfg,crs=4326)
FLW_KTBN_sf <- st_as_sf(FLW_KTBN_sfc)
FLW_KTBN_sf$Name <- 'Ft Leonard Wood, MO'

#FBGA = Fort Benning, GA
FBGA_KLSF_sfg <- st_point(c(-84.97,32.35))
FBGA_KLSF_sfc <- st_sfc(FBGA_KLSF_sfg,crs=4326)
FBGA_KLSF_sf <- st_as_sf(FBGA_KLSF_sfc)
FBGA_KLSF_sf$Name <- 'Ft Benning, BA'

#All on the same MapView
Guage_Locations_df <- rbind(FBGA_KLSF_sf,FLW_KTBN_sf,FJSC_KCUB_sf,FSOK_KFSI_sf)
#basic_installation_map <- mapview(Guage_Locations_df)
#print(basic_installation_map)

#Individual Installations
FBGA_Installations_sf <- All_Installations_sf%>%
  select('FULLNAME','geometry')%>%
  filter(FULLNAME=="Ft Benning")
FJSC_Installations_sf <- All_Installations_sf%>%
  select('FULLNAME','geometry')%>%
  filter(FULLNAME=="Ft Jackson")
FSOK_Installations_sf <- All_Installations_sf%>%
  select('FULLNAME','geometry')%>%
  filter(FULLNAME=="Ft Sill")
FLW_Installations_sf <- All_Installations_sf%>%
  select('FULLNAME','geometry')%>%
  filter(FULLNAME=="Ft Leonard Wood")
```

```{r}

mapview(All_Installations_sf, zcol="FULLNAME",layer_name="Basic Training Installations",alpha=1,legend=FALSE)+
  mapview(Guage_Locations_df, cex=3, layer.name="Installation Gauge Locations")
```

Ft Sill, OK and Ft Jackson, SC, sharing the #2 rank was initially surprising given the much greater difference Ft Sill, OK is from the moderating effects of any large water body. After referencing the National Weather Service, both of these installations are located in the same climate subdivision, "Cfa" or Humid Subtropical, and are at roughly the same latitude. This appears to explain the similarity in the number of high heat days.

From a heat injury risk standpoint, Ft Benning is clearly the basic training installation at greatest risk of high heat days. Soldiers at Ft Benning would be expected to be at higher risk of heat related injury, something that has been found in studies exploring the incidents of per-capita heat illness at training installations (Defense Health Agency, 2022; )

\newpage

# Summary and Conclusions

Our initial hypothesis was there would be a significant increase in high temperatures and wet bulb temperatures over the observation period. The results of the analysis show that there has not been a significant trend in higher temperatures between 2012 and 2022. After initially plotting the max temperatures values for each location, there was an observable upward trend line. The trend line for high temperatures indicated that there has been some increase in high temperatures for each location. However, the time series analysis for both seasonal and seasonally corrected Mann Kendall tests contradicts this conclusion. The only temperature change p-value that was below .05 was Fort Benning. Based on current climate change trends, we expected to see a greater number of high temperature days for each location. One possible explanation for this result is that temperatures have been consistently higher over the last ten years. If we performed the Mann Kendall test on data from 2002-2022, we might observe a different result.

Prior to analysis, we also hypothesized that there would be an observable increase in wet bulb temperatures over the analysis period. The results of the Mann Kendall test run for the full year (January -- December) indicated a significant trend for all locations except Fort Leonard Wood. However, the time series analysis for just the warmest months of the year (April -- September) only resulted in significant p-values for Fort Jackson and Fort Sill. The variation between the time series analysis indicates that higher temperatures from cooler months influenced the results of the previous analysis. Although the significant trend of warmer temperatures throughout the entire year is an interesting result, our primary research question focused on whether there was a significant trend in high temperatures that could negatively impact human health.

The significant change for wet bulb temperatures compared to the insignificant results of the temperature trend is an especially interesting result. Wet bulb temperature values account for humidity, solar intensity, and wind. The significant values for wet bulb temperature indicates climate conditions apart from just temperature are changing over time. To deduce what climate conditions are influencing the change in wet bulb temperature, we would need data on the climate conditions for the same analysis period and run a similar time series analysis as we did in this study. We could also run a statistical analysis to look at the correlation between other climate conditions and wet bulb temperature. The combination of correlation values and time series analysis on other climate conditions could explain the variation between temperature and wet bulb temperature trends. The variation in wet bulb temperature results also implies that climate change conditions are occurring at different rates across the United States. If we wanted to take this project even further, we could expand the scope to include multiple sites in each state. Instead of looking at just single sites, we could monitor regional temperature and wet bulb temperature trends.

\newpage

# References

Defense Health Agency, 2022. Medical Surveillance Monthly Report, April 2022, "Update: Heat Illness, Active Component, U.S. Armed Forces, 2021". Available from: <https://www.health.mil/Military-Health-Topics/Health-Readiness/AFHSD/Reports-and-Publications/Medical-Surveillance-Monthly-Report>

Defense Health Agency, 2019. Medical Surveillance Monthly Report, April 2019, "Incidence, Timing, and Seasonal Patterns of Heat Illnesses During U.S. Army Basic Combat Training, 2014--2018". Available from: <https://www.health.mil/Military-Health-Topics/Health-Readiness/AFHSD/Reports-and-Publications/Medical-Surveillance-Monthly-Report>
